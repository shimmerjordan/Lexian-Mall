<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lexian.mapper.OrderMapper">
    <resultMap id="order_map" type="Order">
        <id property="ID" column="ID"/>
        <result property="date" column="date"/>
        <result property="description" column="description"/>
        <result property="name" column="name"/>
        <result property="comment" column="comment"/>
        <result property="status" column="status"/>
        <result property="quantity" column="commodity_quantity"/>
        <result property="price" column="price"/>
    </resultMap>

    <select id="getAllOrder" resultMap="order_map">
        SELECT
        orders.ID,
        orders.date,
        orders.description,
        orders.`comment`,
        orders.`status`,
        commodity.`name`,
        order_item.commodity_quantity,
        commodity.price
        FROM
        orders
        INNER JOIN order_item ON order_item.order_id = orders.ID
        INNER JOIN commodity ON order_item.commodity_id = commodity.ID
        WHERE
        isDelete = 0
    </select>

    <select id="getDateRange" resultType="java.lang.Integer">
        SELECT
        count(*)
        FROM
        orders
        WHERE
        orders.date BETWEEN #{0} AND #{1}
        GROUP BY
        orders.date
    </select>

    <insert id="addOrder"  parameterType="java.util.HashMap">
        INSERT INTO
        orders(orders.date,orders.description,orders.`comment`,orders.`status`)
        VALUES
        (#{timestamp },#{description},#{comment},#{status})
    </insert>

    <insert id="addOrder_Item" parameterType="java.util.HashMap">
        INSERT INTO
        order_item(order_id,commodity_id,commodity_quantity)
        VALUES
        ((SELECT LAST_INSERT_ID()),#{commodity},#{quantity})
    </insert>

    <update id="updateOrder" parameterType="java.util.HashMap">
        UPDATE
        orders
        SET
        orders.date=#{ timestamp },
        orders.description=#{ description },
        orders.`comment`=#{ comment },
        orders.`status`=#{ status }
        WHERE
        orders.ID=#{id}
    </update>

    <update id="updateOrder_Item" parameterType="java.util.HashMap">
        UPDATE
        order_item
        SET
        order_item.commodity_quantity=#{ quantity }
        WHERE
        order_item.order_id=#{ id }
    </update>

</mapper>